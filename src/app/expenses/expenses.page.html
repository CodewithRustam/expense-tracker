<ion-header class="ion-no-border" [translucent]="true">
  <ion-buttons slot="start">
    <ion-back-button defaultHref="tabs/home" icon="arrow-back-outline"></ion-back-button>
    <ion-title>Expense Dashboard</ion-title>
  </ion-buttons>
  <div class="top-gradient-mask"></div>
</ion-header>

<ion-content [scrollEvents]="true" (ionScroll)="onScroll($event)">

  <!-- ================= DESKTOP SHELL ================= -->
  <div class="expense-desktop-shell">

    <!-- ============== LEFT SIDE ================= -->
    <div class="expense-left">

      <div class="hub-container">
        <div class="glass-hub">

          <!-- HEADER -->
          <div class="hub-header-row">
            <ng-container *ngIf="!isLoading; else headerSkeleton">
              <h1 class="room-name" title="{{ roomName }}">
                {{ roomName }}
              </h1>

              <div class="month-capsule">
                <ion-button fill="clear" (click)="previousMonth()" [disabled]="isPrevMonthDisabled">
                  <i class="fa-solid fa-chevron-left"></i>
                </ion-button>

                <span class="selected-month">{{ selectedMonth }}</span>

                <ion-button fill="clear" (click)="nextMonth()" [disabled]="isNextMonthDisabled">
                  <i class="fa-solid fa-chevron-right"></i>
                </ion-button>
              </div>
            </ng-container>
          </div>

          <!-- STATS -->
          <div class="hub-stats-row">
            <ng-container *ngIf="!isLoadingExpenses; else statsSkeleton">
              <ion-icon name="wallet-outline" style="font-size:x-large"></ion-icon>
              <div class="stat-item">
                <span class="s-label">Total Spent</span>
                <span class="s-val">₹{{ totalAllTime | number:'1.0-0' }}</span>
              </div>

              <div class="stat-divider"></div>

              <ion-icon name="people-outline" style="font-size:x-large"></ion-icon>
              <div class="stat-item">
                <span class="s-label">Avg/Person</span>
                <span class="s-val">₹{{ averageAmount | number:'1.0-0' }}</span>
              </div>
            </ng-container>
          </div>

          <!-- MEMBERS -->
          <div class="hub-members">
            <div class="member-track">
              <ng-container *ngIf="!isLoading; else membersSkeleton">
                <div class="member-chip" *ngFor="let u of users" (click)="selectUser(u.memberId)"
                  [class.active]="selectedUser === u.memberId">

                  <div class="avatar-sq">{{ u.memberName.charAt(0) }}</div>
                  <span class="chip-name">{{ u.memberName.split(' ')[0] }}</span>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- PERSONAL CARD -->
          <div class="hub-personal-zone">
            <ng-container *ngIf="!isLoadingExpenses; else cardSkeleton">
              <ng-container *ngFor="let user of users">
                <div class="holo-mini-card" *ngIf="selectedUser === user.memberId">
                  <div class="m-left">
                    <span class="m-tag">My Total</span>
                    <h2 class="m-amt">₹{{ user.totalMemberExpense | number:'1.2-2' }}</h2>
                  </div>
                  <div class="m-right" [ngClass]="user.netBalance >= 0 ? 'pos' : 'neg'">
                    <div class="status-stack" *ngIf="user.badgeText !== 'Settled up'; else settledTpl">
                      <span class="st-label">
                        {{ user.netBalance >= 0 ? 'Gets Back' : 'Owes' }}
                      </span>
                      <span class="st-val">
                        ₹{{ (user.netBalance < 0 ? -user.netBalance : user.netBalance) | number:'1.0-0' }} </span>
                    </div>

                    <ng-template #settledTpl>
                      <div class="settled-stack">
                        <span class="settledlbl">
                          <ion-icon name="checkmark-circle-outline"></ion-icon>
                          Settled
                        </span>

                        <span *ngIf="user.amountPaid > 0" class="amount-badge paid-badge">
                          Paid: {{ user.amountPaid | currency:'INR':'symbol':'1.2-2' }}
                        </span>

                        <span *ngIf="user.amountReceived > 0" class="amount-badge received-badge">
                          Received: {{ user.amountReceived | currency:'INR':'symbol':'1.2-2' }}
                        </span>
                      </div>
                    </ng-template>

                    <ion-button *ngIf="user.netBalance < 0 && user.isSettleShow" size="small" class="btn-settle"
                      (click)="openSettleModal(user)">
                      Settle
                    </ion-button>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </div>

        </div>
      </div>

    </div>

    <!-- ============== RIGHT SIDE ================= -->
    <div class="expense-right">

      <div class="sticky-history-bar">
        <div class="history-content">
          <span>Transaction History</span>
          <div class="h-line"></div>
        </div>
      </div>

      <div class="ledger-container">

        <!-- LOADING -->
        <ng-container *ngIf="isLoadingExpenses">
          <ion-item-sliding *ngFor="let i of [1,2,3,4,5]" class="ledger-slider">
            <ion-item lines="none" class="ledger-glass-panel">
              <div class="transaction-row">
                <div class="row-left">
                  <ion-skeleton-text animated class="skeleton-icon"></ion-skeleton-text>
                  <div class="text-group">
                    <ion-skeleton-text animated class="skeleton-tx-title"></ion-skeleton-text>
                    <ion-skeleton-text animated class="skeleton-tx-meta"></ion-skeleton-text>
                  </div>
                </div>
                <div class="row-right">
                  <ion-skeleton-text animated class="skeleton-tx-amt"></ion-skeleton-text>
                </div>
              </div>
            </ion-item>
          </ion-item-sliding>
        </ng-container>

        <!-- DATA -->
        <ng-container *ngIf="!isLoadingExpenses">
          <ng-container *ngFor="let user of users">
            <ng-container *ngIf="selectedUser === user.memberId">
              <ion-item-sliding *ngFor="let exp of user.expenses" class="ledger-slider">
                <ion-item lines="none" class="ledger-glass-panel">
                  <div class="transaction-row">
                    <div class="row-left">
                      <div class="icon-wrapper">
                        <i [class]="exp.iconName" [style.color]="getIconColor(exp.iconName)"></i>
                      </div>
                      <div class="text-group">
                        <span class="tx-name">{{ exp.item }}</span>
                        <span class="tx-meta">{{ exp.category }} • {{ exp.date }}</span>
                      </div>
                    </div>

                    <div class="row-right">
                      <div class="tx-amount" [class.pos]="exp.amount > 0">
                        ₹{{ exp.amount | number:'1.0-0' }}
                      </div>
                      <div *ngIf="exp.isEditShow" class="edit-btn-mini" (click)="openEditExpenseModal(exp)">
                        Edit
                      </div>
                    </div>
                  </div>
                </ion-item>
              </ion-item-sliding>
            </ng-container>
          </ng-container>
        </ng-container>

        <!-- EMPTY -->
        <ng-container *ngIf="!isLoadingExpenses && !hasExpensesInSelectedMonth()">
          <div class="empty-ledger">
            <i class="fa-solid fa-ghost"></i>
            <p>No transactions found</p>
          </div>
        </ng-container>

      </div>

    </div>

  </div>
</ion-content>

<!-- ================= SKELETONS ================= -->
<ng-template #headerSkeleton>
  <ion-skeleton-text animated class="room-name-skeleton"></ion-skeleton-text>
  <ion-skeleton-text animated class="month-skel"></ion-skeleton-text>
</ng-template>

<ng-template #statsSkeleton>
  <ion-skeleton-text animated style="width:120px;height:20px"></ion-skeleton-text>
</ng-template>

<ng-template #membersSkeleton>
  <div class="member-chip" *ngFor="let i of [1,2,3]">
    <ion-skeleton-text animated class="skeleton-avatar"></ion-skeleton-text>
  </div>
</ng-template>

<ng-template #cardSkeleton>
  <div class="holo-mini-card">
    <ion-skeleton-text animated style="width:140px;height:24px"></ion-skeleton-text>
  </div>
</ng-template>